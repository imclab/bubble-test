function addCommas(a){a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";var b=/(\d+)(\d{3})/;while(b.test(x1))x1=x1.replace(b,"$1,$2");return x1+x2}function CustomTooltip(a,b){function c(b,c){$("#"+a).html(b),$("#"+a).show(),e(c)}function d(){$("#"+a).hide()}function e(b){var c="#"+a,d=20,e=10,f=$(c).width(),g=$(c).height(),h=$(window).scrollTop(),i=$(window).scrollLeft(),j=document.all?b.clientX+i:b.pageX,k=document.all?b.clientY+h:b.pageY,l=j-i+d*2+f>$(window).width()?j-f-d*2:j+d;l<i+d&&(l=i+d);var m=k-h+e*2+g>$(window).height()?k-g-e*2:k+e;m<h+e&&(m=k+e),$(c).css("top",m+"px").css("left",l+"px")}var a=a;return $("body").append("<div class='tooltip' id='"+a+"'></div>"),b&&$("#"+a).css("width",b),d(),{showTooltip:c,hideTooltip:d,updatePosition:e}}window.log=function(){log.history=log.history||[],log.history.push(arguments);if(this.console){arguments.callee=arguments.callee.caller;var a=[].slice.call(arguments);typeof console.log=="object"?log.apply.call(console.log,console,a):console.log.apply(console,a)}},function(a){function b(){}for(var c="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,timeStamp,profile,profileEnd,time,timeEnd,trace,warn".split(","),d;d=c.pop();)a[d]=a[d]||b}(function(){try{return console.log(),window.console}catch(a){return window.console={}}}()),function(){var a,b,c,d,e,f=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a){this.hide_details=f(this.hide_details,this),this.show_details=f(this.show_details,this),this.hide_scales=f(this.hide_scales,this),this.display_scales=f(this.display_scales,this),this.move_torwards_location_center=f(this.move_torwards_location_center,this),this.move_torwards_scale=f(this.move_torwards_scale,this),this.display_dc_vs_nation=f(this.display_dc_vs_nation,this),this.display_rent_vs_remaining=f(this.display_rent_vs_remaining,this),this.move_towards_center=f(this.move_towards_center,this),this.buoyancy=f(this.buoyancy,this),this.display_group_all=f(this.display_group_all,this),this.set_display=f(this.set_display,this),this.start=f(this.start,this),this.create_vis=f(this.create_vis,this),this.create_nodes=f(this.create_nodes,this),this.add_key=f(this.add_key,this),this.set_annotations=f(this.set_annotations,this);var b,c,d,e;this.data=a,this.width=950,this.height=700,this.pb=40,this.pt=120,this.pl=90,this.pr=10,this.tick_inc=0,this.current_display="all",this.states_centers={},this.tooltip=CustomTooltip("bubble_tooltip",240),this.center={x:this.width/2+70,y:this.height/2+20},this.location_centers=[{x:this.width/3,y:this.height/2},{x:2*this.width/3-30,y:this.height/2}],this.layout_gravity=-0.01,this.damper=.1,this.vis=null,this.nodes=[],this.force=null,this.circles=null,this.fill_color=d3.scale.ordinal().domain([1,2,3,4,5]).range(["#D7191C","#FDAE61","#FFFFBF","#ABD9E9","#2C7BB6"].reverse()),c=2386940,this.radius_scale=d3.scale.pow().exponent(.5).domain([0,c]).range([1,42]),b=d3.extent(this.data,function(a){return a.category_value}),b=[3.33,68.75],this.category_scale=d3.scale.quantize().domain(b).range([1,2,3,4,5]),this.category_scale=function(a){return a<15?1:a<30?2:a<45?3:a<60?4:5},d=d3.extent(this.data,function(a){return a.remaining_term_years}),this.lease_scale=d3.scale.linear().domain([0,20]).range([0,this.width-(this.pl+this.pr)]),this.x_axis=d3.svg.axis().scale(this.lease_scale).tickSubdivide(1).tickSize(5,0).orient("bottom"),e=d3.extent(this.data,function(a){return a.total_rent}),this.total_rent_scale=d3.scale.linear().domain(e).range([0,this.height-(this.pt+this.pb)].reverse()),this.y_axis=d3.svg.axis().scale(this.total_rent_scale).ticks(5).orient("left").tickSize(-this.width,0).tickFormat(function(a){return"$"+a/1e6+" million"}),this.create_nodes(),this.set_annotations(),this.add_key(),this.create_vis()}return a.prototype.set_annotations=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;return n=d3.sum(this.data,function(a){return a.lease_rsf_value}),l=d3.sum(this.data,function(a){return a.annual_rent_value}),m=Math.round(l/1e7)/100,d="There are "+this.data.length+" leases in the United States that are larger than 75,000 RSF.  Together, these total "+addCommas(n)+" RSF and $"+addCommas(m)+" billion in annual rent.",$("#inventory-annotation-text").html(d),a=this.data.filter(function(a){return parseInt(a.region)===11}),h=this.data.filter(function(a){return parseInt(a.region)!==11}),c=d3.sum(a,function(a){return a.lease_rsf_value}),j=d3.sum(h,function(a){return a.lease_rsf_value}),b=""+a.length+" leases totaling "+addCommas(c)+" RSF",i=""+h.length+" leases totaling "+addCommas(j)+" RSF",$("#dc-annotation-text").html(b),$("#nation-annotation-text").html(i),f=this.data.filter(function(a){return parseFloat(a.remaining_term_years)>=10}),g=d3.sum(f,function(a){return a.lease_rsf_value}),e=Math.round(f.length/this.data.length*1e3)/10,k=""+f.length+" leases ("+addCommas(g)+" RSF) have remaining lease terms longer than 10 years.  This is "+e+"% of the number of leases in the analysis size range.",$("#rent-annotation-text").html(k)},a.prototype.add_key=function(){var a,b,c,d,e,f;return c=d3.select("#chart-key-svg"),c.append("circle").attr("r",this.radius_scale(2e6)).attr("class","chart-key-circle").attr("cx",40).attr("cy",44),c.append("circle").attr("r",this.radius_scale(1e6)).attr("class","chart-key-circle").attr("cx",40).attr("cy",55),c.append("circle").attr("r",this.radius_scale(5e5)).attr("class","chart-key-circle").attr("cx",40).attr("cy",63),f=this,a=d3.select("#chart-key-color-svg"),e=34,d=12,b=a.selectAll("rect").data([1,2,3,4,5]).enter(),b.append("rect").attr("x",function(a,b){return b*e}).attr("width",e).attr("height",d).attr("fill",function(a){return f.fill_color(a)}),a.selectAll("color-label").data([15,30,45,60,75]).enter().append("text").attr("class","color-label").attr("x",function(a,b){return b*e+e}).attr("y",function(a,b){return d+12}).attr("text-anchor","end").text(function(a){return"$"+a})},a.prototype.create_nodes=function(){var a=this;return this.data.forEach(function(b,c){var d;return d={id:c,radius:a.radius_scale(b.size),category:a.category_scale(b.category_value),location_index:parseInt(b.region)===11?0:1,value:b.size,city:b.city.toUpperCase(),state:b.state.toUpperCase(),state_category:b.state_category,address:b.address.toUpperCase(),remaining_term_years:b.remaining_term_years,total_rent:b.total_rent,rent_prsf:b.rent_prsf,rent_prsf_value:b.rent_prsf_value,lease_rsf_value:b.lease_rsf_value,org:b.organization,year:b.start_year,x:Math.random()*900,y:Math.random()*800},a.nodes.push(d)}),this.nodes.sort(function(a,b){return b.value-a.value})},a.prototype.create_vis=function(){var a,b=this;return this.vis=d3.select("#chart-canvas").append("svg").attr("width",this.width).attr("height",this.height).attr("id","svg_vis"),this.circles=this.vis.selectAll("circle").data(this.nodes,function(a){return a.id}),a=this,this.circles.enter().append("circle").attr("r",0).attr("fill",function(a){return b.fill_color(a.category)}).attr("stroke-width",.7).attr("stroke",function(a){return d3.rgb(b.fill_color(a.category)).darker().toString()}).attr("id",function(a){return"bubble_"+a.id}).attr("class","chart-bubble").on("mouseover",function(b,c){return a.show_details(b,c,this)}).on("mouseout",function(b,c){return a.hide_details(b,c,this)}),this.circles.transition().duration(2e3).attr("r",function(a){return a.radius})},a.prototype.charge=function(a){return-Math.pow(a.radius,2)/8},a.prototype.start=function(){return this.force=d3.layout.force().nodes(this.nodes).size([this.width,this.height])},a.prototype.set_display=function(a){return this.current_display=a,this.current_display==="all"?this.display_group_all():this.current_display==="dc_vs_nation"?this.display_dc_vs_nation():this.current_display==="rent_vs_remaining"?this.display_rent_vs_remaining():this.display_group_all()},a.prototype.display_group_all=function(){var a=this;return this.force.gravity(this.layout_gravity).charge(this.charge).friction(.9).on("tick",function(b){return a.circles.each(a.move_towards_center(b.alpha)).each(a.buoyancy(b.alpha)),a.circles.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),a.tick_inc+=1}),this.force.start(),this.hide_scales()},a.prototype.buoyancy=function(a){var b=this;return function(c){var d;return d=b.center.y-c.category*130,c.y=c.y+(d-c.y)*.07*a*a*a*100}},a.prototype.move_towards_center=function(a){var b=this;return function(c){return c.x=c.x+(b.center.x-c.x)*(b.damper+.02)*a,c.y=c.y+(b.center.y-c.y)*(b.damper+.02)*a}},a.prototype.display_rent_vs_remaining=function(){var a=this;return this.force.gravity(0).charge(0).friction(.2).on("tick",function(b){return a.circles.each(a.move_torwards_scale(b.alpha)).each(a.buoyancy(b.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}),this.force.start(),this.display_scales()},a.prototype.display_dc_vs_nation=function(){var a=this;return this.force.gravity(this.layout_gravity).charge(this.charge).friction(.9).on("tick",function(b){return a.circles.each(a.move_torwards_location_center(b.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}),this.force.start(),this.hide_scales()},a.prototype.move_torwards_scale=function(a){var b=this;return function(c){var d;return d={},d.x=b.lease_scale(c.remaining_term_years)+b.pl,d.y=b.total_rent_scale(c.total_rent)+b.pt,c.y=c.y+(d.y-c.y)*Math.sin(Math.PI*(1-a*10))*.2,c.x=c.x+(d.x-c.x)*Math.sin(Math.PI*(1-a*10))*.1}},a.prototype.move_torwards_location_center=function(a){var b=this;return function(c){var d;return d=b.location_centers[c.location_index],c.x=c.x+(d.x-c.x)*(b.damper+.02)*a*1.1,c.y=c.y+(d.y-c.y)*(b.damper+.02)*a*1.1}},a.prototype.display_scales=function(){var a,b;return a=this.vis.insert("g",".chart-bubble").attr("id","chart-x-axis").attr("class","x axis").attr("transform","translate("+this.pl+","+(this.height-this.pb)+")"),a.call(this.x_axis),b=this.vis.insert("g",".chart-bubble").attr("id","chart-y-axis").attr("class","y axis").attr("transform","translate("+this.pl+","+this.pt+")"),b.call(this.y_axis),a.append("text").attr("class","axis-text").attr("transform","translate("+(this.width/2-40)+","+30+")").attr("text-anchor","middle").text("Remaining Lease Term (Yrs)"),b.append("text").attr("class","axis-text").attr("transform","translate("+(-this.pl+10)+","+(this.height/2-55)+")rotate(-90)").attr("text-anchor","start").text("Total Annual Rent"),b.append("line").attr("class","axis-line").attr("x1",this.lease_scale(10)).attr("y1",0).attr("x2",this.lease_scale(10)).attr("y2",this.height-(this.pb+this.pt)),b.append("line").attr("class","axis-line").attr("x1",this.lease_scale(5)).attr("y1",0).attr("x2",this.lease_scale(5)).attr("y2",this.height-(this.pb+this.pt)),b.append("line").attr("class","axis-line").attr("x1",this.lease_scale(15)).attr("y1",0).attr("x2",this.lease_scale(15)).attr("y2",this.height-(this.pb+this.pt))},a.prototype.hide_scales=function(){return this.vis.select("#chart-x-axis").remove(),this.vis.select("#chart-y-axis").remove()},a.prototype.show_details=function(a,b,c){var d;return d3.select(c).attr("stroke","black"),d='<p class="main">'+a.address+"<br/>"+a.city+", "+a.state+'</p><hr class="tooltip-hr">',d+='<span class="name">RSF:</span><span class="value"> '+addCommas(a.lease_rsf_value)+"</span><br/>",d+='<span class="name">Rent:</span><span class="value"> '+a.rent_prsf+"/RSF</span><br/>",this.tooltip.showTooltip(d,d3.event)},a.prototype.hide_details=function(a,b,c){var d=this;return d3.select(c).attr("stroke",function(a){return d3.rgb(d.fill_color(a.category)).darker().toString()}),this.tooltip.hideTooltip()},a}(),e=typeof exports!="undefined"&&exports!==null?exports:this,c=function(a){return a.replace(/[\"\,\$]/g,"")},b=function(a){return a.forEach(function(a){return a.size=parseInt(c(a.lease_rsf)),a.lease_rsf_value=parseInt(c(a.lease_rsf)),a.category_value=parseFloat(c(a.rent_prsf)),a.rent_prsf_value=parseFloat(c(a.rent_prsf)),a.remaining_term_years=parseFloat(a.remaining_term_years),a.annual_rent_value=parseFloat(c(a.annual_rent)),a.total_rent=parseFloat(c(a.annual_rent))}),a},d=function(a){var b;return b=a.filter(function(a){return a.lease_rsf_value>75e3}),b},$(function(){var c,f,g,h=this;return c=null,f=function(e){var f;return f=d(b(e)),c=new a(f),c.start(),c.set_display("all")},g=function(a){var b,c,d,e;return d=700,e={all:{name:"#chart-all-overlay",height:d},dc_vs_nation:{name:"#chart-dc-vs-nation-overlay",height:d},rent_vs_remaining:{name:"#chart-rent-vs-remaining-overlay",height:d+40},state:{name:"#chart-state-overlay",height:d}},d3.values(e).forEach(function(a){return $(a.name).hide()}),b=e[a],b||(b=e.all),c=$(b.name),c.delay(300).fadeIn(500),$("#chart-frame").css({height:b.height})},e.toggle_view=function(a){return g(a),c.set_display(a)},d3.csv("data/inventory_abridged.csv",f)})}.call(this);