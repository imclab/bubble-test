function addCommas(e){e+="",x=e.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";var t=/(\d+)(\d{3})/;while(t.test(x1))x1=x1.replace(t,"$1,$2");return x1+x2}function CustomTooltip(e,t){function n(t,n){$("#"+e).html(t),$("#"+e).show(),i(n)}function r(){$("#"+e).hide()}function i(t){var n="#"+e,r=20,i=10,s=$(n).width(),o=$(n).height(),u=$(window).scrollTop(),a=$(window).scrollLeft(),f=document.all?t.clientX+a:t.pageX,l=document.all?t.clientY+u:t.pageY,c=f-a+r*2+s>$(window).width()?f-s-r*2:f+r;c<a+r&&(c=a+r);var h=l-u+i*2+o>$(window).height()?l-o-i*2:l+i;h<u+i&&(h=l+i),$(n).css("top",h+"px").css("left",c+"px")}var e=e;return $("body").append("<div class='tooltip' id='"+e+"'></div>"),t&&$("#"+e).css("width",t),r(),{showTooltip:n,hideTooltip:r,updatePosition:i}}window.log=function(){log.history=log.history||[],log.history.push(arguments);if(this.console){arguments.callee=arguments.callee.caller;var e=[].slice.call(arguments);typeof console.log=="object"?log.apply.call(console.log,console,e):console.log.apply(console,e)}},function(e){function t(){}for(var n="assert,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,timeStamp,profile,profileEnd,time,timeEnd,trace,warn".split(","),r;r=n.pop();)e[r]=e[r]||t}(function(){try{return console.log(),window.console}catch(e){return window.console={}}}()),function(){var e,t,n,r,i,s=function(e,t){return function(){return e.apply(t,arguments)}};e=function(){function e(e){this.hide_details=s(this.hide_details,this),this.show_details=s(this.show_details,this),this.hide_scales=s(this.hide_scales,this),this.display_scales=s(this.display_scales,this),this.move_torwards_location_center=s(this.move_torwards_location_center,this),this.move_torwards_scale=s(this.move_torwards_scale,this),this.display_dc_vs_nation=s(this.display_dc_vs_nation,this),this.display_rent_vs_remaining=s(this.display_rent_vs_remaining,this),this.move_towards_center=s(this.move_towards_center,this),this.buoyancy=s(this.buoyancy,this),this.display_group_all=s(this.display_group_all,this),this.set_display=s(this.set_display,this),this.start=s(this.start,this),this.create_vis=s(this.create_vis,this),this.create_nodes=s(this.create_nodes,this),this.add_key=s(this.add_key,this),this.set_annotations=s(this.set_annotations,this);var t,n,r,i;this.data=e,this.width=950,this.height=700,this.pb=40,this.pt=120,this.pl=90,this.pr=10,this.tick_inc=0,this.current_display="all",this.states_centers={},this.tooltip=CustomTooltip("bubble_tooltip",240),this.center={x:this.width/2+70,y:this.height/2+20},this.location_centers=[{x:this.width/3,y:this.height/2},{x:2*this.width/3-30,y:this.height/2}],this.layout_gravity=-0.01,this.damper=.1,this.vis=null,this.nodes=[],this.force=null,this.circles=null,this.fill_color=d3.scale.ordinal().domain([1,2,3,4,5]).range(["#D7191C","#FDAE61","#FFFFBF","#ABD9E9","#2C7BB6"].reverse()),n=2386940,this.radius_scale=d3.scale.pow().exponent(.5).domain([0,n]).range([1,42]),t=d3.extent(this.data,function(e){return e.category_value}),t=[3.33,68.75],this.category_scale=d3.scale.quantize().domain(t).range([1,2,3,4,5]),this.category_scale=function(e){return e<15?1:e<30?2:e<45?3:e<60?4:5},r=d3.extent(this.data,function(e){return e.remaining_term_years}),this.lease_scale=d3.scale.linear().domain([0,20]).range([0,this.width-(this.pl+this.pr)]),this.x_axis=d3.svg.axis().scale(this.lease_scale).tickSubdivide(1).tickSize(5,0).orient("bottom"),i=d3.extent(this.data,function(e){return e.total_rent}),this.total_rent_scale=d3.scale.linear().domain(i).range([0,this.height-(this.pt+this.pb)].reverse()),this.y_axis=d3.svg.axis().scale(this.total_rent_scale).ticks(5).orient("left").tickSize(-this.width,0).tickFormat(function(e){return"$"+e/1e6+" million"}),this.create_nodes(),this.set_annotations(),this.add_key(),this.create_vis()}return e.prototype.set_annotations=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p;return p=d3.sum(this.data,function(e){return e.lease_rsf_value}),c=d3.sum(this.data,function(e){return e.annual_rent_value}),h=Math.round(c/1e7)/100,r="There are "+this.data.length+" leases in the United States that are larger than 75,000 RSF.  Together, these total "+addCommas(p)+" RSF and $"+addCommas(h)+" billion in annual rent.",$("#inventory-annotation-text").html(r),e=this.data.filter(function(e){return parseInt(e.region)===11}),u=this.data.filter(function(e){return parseInt(e.region)!==11}),n=d3.sum(e,function(e){return e.lease_rsf_value}),f=d3.sum(u,function(e){return e.lease_rsf_value}),t=""+e.length+" leases totaling "+addCommas(n)+" RSF",a=""+u.length+" leases totaling "+addCommas(f)+" RSF",$("#dc-annotation-text").html(t),$("#nation-annotation-text").html(a),s=this.data.filter(function(e){return parseFloat(e.remaining_term_years)>=10}),o=d3.sum(s,function(e){return e.lease_rsf_value}),i=Math.round(s.length/this.data.length*1e3)/10,l=""+s.length+" leases ("+addCommas(o)+" RSF) have remaining lease terms longer than 10 years.  This is "+i+"% of the number of leases in the analysis size range.",$("#rent-annotation-text").html(l)},e.prototype.add_key=function(){var e,t,n,r,i,s;return n=d3.select("#chart-key-svg"),n.append("circle").attr("r",this.radius_scale(2e6)).attr("class","chart-key-circle").attr("cx",40).attr("cy",44),n.append("circle").attr("r",this.radius_scale(1e6)).attr("class","chart-key-circle").attr("cx",40).attr("cy",55),n.append("circle").attr("r",this.radius_scale(5e5)).attr("class","chart-key-circle").attr("cx",40).attr("cy",63),s=this,e=d3.select("#chart-key-color-svg"),i=34,r=12,t=e.selectAll("rect").data([1,2,3,4,5]).enter(),t.append("rect").attr("x",function(e,t){return t*i}).attr("width",i).attr("height",r).attr("fill",function(e){return s.fill_color(e)}),e.selectAll("color-label").data([15,30,45,60,75]).enter().append("text").attr("class","color-label").attr("x",function(e,t){return t*i+i}).attr("y",function(e,t){return r+12}).attr("text-anchor","end").text(function(e){return"$"+e})},e.prototype.create_nodes=function(){var e=this;return this.data.forEach(function(t,n){var r;return r={id:n,radius:e.radius_scale(t.size),category:e.category_scale(t.category_value),location_index:parseInt(t.region)===11?0:1,value:t.size,city:t.city.toUpperCase(),state:t.state.toUpperCase(),state_category:t.state_category,address:t.address.toUpperCase(),remaining_term_years:t.remaining_term_years,total_rent:t.total_rent,rent_prsf:t.rent_prsf,rent_prsf_value:t.rent_prsf_value,lease_rsf_value:t.lease_rsf_value,org:t.organization,year:t.start_year,x:Math.random()*900,y:Math.random()*800},e.nodes.push(r)}),this.nodes.sort(function(e,t){return t.value-e.value})},e.prototype.create_vis=function(){var e,t=this;return this.vis=d3.select("#chart-canvas").append("svg").attr("width",this.width).attr("height",this.height).attr("id","svg_vis"),this.circles=this.vis.selectAll("circle").data(this.nodes,function(e){return e.id}),e=this,this.circles.enter().append("circle").attr("r",0).attr("fill",function(e){return t.fill_color(e.category)}).attr("stroke-width",.7).attr("stroke",function(e){return d3.rgb(t.fill_color(e.category)).darker()}).attr("id",function(e){return"bubble_"+e.id}).attr("class","chart-bubble").on("mouseover",function(t,n){return e.show_details(t,n,this)}).on("mouseout",function(t,n){return e.hide_details(t,n,this)}),this.circles.transition().duration(2e3).attr("r",function(e){return e.radius})},e.prototype.charge=function(e){return-Math.pow(e.radius,2)/8},e.prototype.start=function(){return this.force=d3.layout.force().nodes(this.nodes).size([this.width,this.height])},e.prototype.set_display=function(e){return this.current_display=e,this.current_display==="all"?this.display_group_all():this.current_display==="dc_vs_nation"?this.display_dc_vs_nation():this.current_display==="rent_vs_remaining"?this.display_rent_vs_remaining():this.display_group_all()},e.prototype.display_group_all=function(){var e=this;return this.force.gravity(this.layout_gravity).charge(this.charge).friction(.9).on("tick",function(t){return e.circles.each(e.move_towards_center(t.alpha)).each(e.buoyancy(t.alpha)),e.circles.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),e.tick_inc+=1}),this.force.start(),this.hide_scales()},e.prototype.buoyancy=function(e){var t=this;return function(n){var r;return r=t.center.y-n.category*130,n.y=n.y+(r-n.y)*.07*e*e*e*100}},e.prototype.move_towards_center=function(e){var t=this;return function(n){return n.x=n.x+(t.center.x-n.x)*(t.damper+.02)*e,n.y=n.y+(t.center.y-n.y)*(t.damper+.02)*e}},e.prototype.display_rent_vs_remaining=function(){var e=this;return this.force.gravity(0).charge(0).friction(.2).on("tick",function(t){return e.circles.each(e.move_torwards_scale(t.alpha)).each(e.buoyancy(t.alpha)).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}),this.force.start(),this.display_scales()},e.prototype.display_dc_vs_nation=function(){var e=this;return this.force.gravity(this.layout_gravity).charge(this.charge).friction(.9).on("tick",function(t){return e.circles.each(e.move_torwards_location_center(t.alpha)).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}),this.force.start(),this.hide_scales()},e.prototype.move_torwards_scale=function(e){var t=this;return function(n){var r;return r={},r.x=t.lease_scale(n.remaining_term_years)+t.pl,r.y=t.total_rent_scale(n.total_rent)+t.pt,n.y=n.y+(r.y-n.y)*Math.sin(Math.PI*(1-e*10))*.2,n.x=n.x+(r.x-n.x)*Math.sin(Math.PI*(1-e*10))*.1}},e.prototype.move_torwards_location_center=function(e){var t=this;return function(n){var r;return r=t.location_centers[n.location_index],n.x=n.x+(r.x-n.x)*(t.damper+.02)*e*1.1,n.y=n.y+(r.y-n.y)*(t.damper+.02)*e*1.1}},e.prototype.display_scales=function(){var e,t;return e=this.vis.insert("g",".chart-bubble").attr("id","chart-x-axis").attr("class","x axis").attr("transform","translate("+this.pl+","+(this.height-this.pb)+")"),e.call(this.x_axis),t=this.vis.insert("g",".chart-bubble").attr("id","chart-y-axis").attr("class","y axis").attr("transform","translate("+this.pl+","+this.pt+")"),t.call(this.y_axis),e.append("text").attr("class","axis-text").attr("transform","translate("+(this.width/2-40)+","+30+")").attr("text-anchor","middle").text("Remaining Lease Term (Yrs)"),t.append("text").attr("class","axis-text").attr("transform","translate("+(-this.pl+10)+","+(this.height/2-55)+")rotate(-90)").attr("text-anchor","start").text("Total Annual Rent"),t.append("line").attr("class","axis-line").attr("x1",this.lease_scale(10)).attr("y1",0).attr("x2",this.lease_scale(10)).attr("y2",this.height-(this.pb+this.pt)),t.append("line").attr("class","axis-line").attr("x1",this.lease_scale(5)).attr("y1",0).attr("x2",this.lease_scale(5)).attr("y2",this.height-(this.pb+this.pt)),t.append("line").attr("class","axis-line").attr("x1",this.lease_scale(15)).attr("y1",0).attr("x2",this.lease_scale(15)).attr("y2",this.height-(this.pb+this.pt))},e.prototype.hide_scales=function(){return this.vis.select("#chart-x-axis").remove(),this.vis.select("#chart-y-axis").remove()},e.prototype.show_details=function(e,t,n){var r;return d3.select(n).attr("stroke","black"),r='<p class="main">'+e.address+"<br/>"+e.city+", "+e.state+'</p><hr class="tooltip-hr">',r+='<span class="name">RSF:</span><span class="value"> '+addCommas(e.lease_rsf_value)+"</span><br/>",r+='<span class="name">Rent:</span><span class="value"> '+e.rent_prsf+"/RSF</span><br/>",this.tooltip.showTooltip(r,d3.event)},e.prototype.hide_details=function(e,t,n){var r=this;return d3.select(n).attr("stroke",function(e){return d3.rgb(r.fill_color(e.category)).darker()}),this.tooltip.hideTooltip()},e}(),i=typeof exports!="undefined"&&exports!==null?exports:this,n=function(e){return e.replace(/[\"\,\$]/g,"")},t=function(e){return e.forEach(function(e){return e.size=parseInt(n(e.lease_rsf)),e.lease_rsf_value=parseInt(n(e.lease_rsf)),e.category_value=parseFloat(n(e.rent_prsf)),e.rent_prsf_value=parseFloat(n(e.rent_prsf)),e.remaining_term_years=parseFloat(e.remaining_term_years),e.annual_rent_value=parseFloat(n(e.annual_rent)),e.total_rent=parseFloat(n(e.annual_rent))}),e},r=function(e){var t;return t=e.filter(function(e){return e.lease_rsf_value>75e3}),t},$(function(){var n,s,o,u=this;return n=null,s=function(i){var s;return s=r(t(i)),n=new e(s),n.start(),n.set_display("all")},o=function(e){var t,n,r,i;return r=700,i={all:{name:"#chart-all-overlay",height:r},dc_vs_nation:{name:"#chart-dc-vs-nation-overlay",height:r},rent_vs_remaining:{name:"#chart-rent-vs-remaining-overlay",height:r+40},state:{name:"#chart-state-overlay",height:r}},d3.values(i).forEach(function(e){return $(e.name).hide()}),t=i[e],t||(t=i.all),n=$(t.name),n.delay(300).fadeIn(500),$("#chart-frame").css({height:t.height})},i.toggle_view=function(e){return o(e),n.set_display(e)},d3.csv("data/inventory_abridged.csv",s)})}.call(this);